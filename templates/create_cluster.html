{% extends "base.html" %}

{% block title %}{{ t('create_cluster.title', id=video_id) }}{% endblock %}

{% block content %}
<div class="page-header">
    <a href="/video/{{ video_id }}" class="back-link">&larr; {{ t('create_cluster.back') }}</a>
    <h1>{{ t('create_cluster.heading') }}</h1>
</div>

<div class="frames-manager">
    <!-- Cluster Info Section -->
    <section class="section frames-section cluster-info-section">
        <div class="cluster-info-form">
            <div class="form-group">
                <label for="clusterName">{{ t('create_cluster.name_label') }}</label>
                <input type="text" id="clusterName" placeholder="{{ t('create_cluster.name_placeholder') }}" maxlength="128">
            </div>
            <div class="form-group">
                <label for="clusterDescription">{{ t('create_cluster.notes_label') }}</label>
                <textarea id="clusterDescription" rows="2" maxlength="2000"
                          placeholder="{{ t('create_cluster.notes_placeholder') }}"></textarea>
            </div>
        </div>
    </section>

    <!-- Reference Frames Section -->
    <section class="section frames-section references-section">
        <div class="section-header">
            <div class="section-title-row">
                <h2>
                    <span class="section-icon">&#9889;</span>
                    {{ t('create_cluster.references_title') }}
                    <span class="reference-counter" id="refCounter">(0/{{ max_refs }})</span>
                </h2>
                <button class="info-btn" onclick="showInfoModal('references')" title="{{ t('common.info_tooltip') }}">&#9432;</button>
            </div>
            <div class="section-actions">
                <button class="btn btn-secondary btn-small" onclick="clearReferences()" id="btnClearRefs" disabled>
                    &#10060; {{ t('create_cluster.clear_all') }}
                </button>
            </div>
        </div>

        <p class="section-description">
            {{ t('create_cluster.references_description') }}
        </p>

        <div class="frames-grid reference-frames-grid" id="referenceFramesGrid">
            <p class="empty-message">{{ t('empty_state.select_frames_hint') }}</p>
        </div>

        <p class="section-hint">
            <span class="hint-icon">&#128161;</span>
            {{ t('create_cluster.references_hint') }}
        </p>
    </section>

    <!-- Library Frames Section (All video frames) -->
    <section class="section frames-section library-section">
        <div class="section-header">
            <div class="section-title-row">
                <h2>
                    <span class="section-icon">&#128193;</span>
                    {{ t('create_cluster.available_frames') }}
                    <span id="framesCount" class="reference-counter">(--)</span>
                </h2>
                <button class="info-btn" onclick="showInfoModal('library')" title="{{ t('common.info_tooltip') }}">&#9432;</button>
            </div>
            <div class="section-actions">
                <span class="selection-info" id="librarySelectionInfo">0 {{ t('common.none') }}</span>
            </div>
        </div>

        <div class="library-toolbar">
            <div class="toolbar-left">
                <label class="checkbox-wrapper">
                    <input type="checkbox" id="selectAllLibrary" onchange="toggleSelectAll()">
                    <span>{{ t('cluster_frames.library_select_all') }}</span>
                </label>
                <div class="filter-group">
                    <label for="frameFilter">{{ t('cluster_frames.library_show') }}</label>
                    <select id="frameFilter" onchange="applyFilter()">
                        <option value="all">{{ t('create_cluster.filter_all') }}</option>
                        <option value="unassigned">{{ t('create_cluster.filter_unassigned') }}</option>
                        <option value="with_face">{{ t('create_cluster.filter_with_face') }}</option>
                    </select>
                </div>
            </div>
            <div class="toolbar-actions">
                <button class="btn btn-secondary btn-small" id="btnAddToRefs" onclick="addSelectedToReferences()" disabled>
                    &#9889; {{ t('create_cluster.add_to_refs') }}
                </button>
                <button class="btn btn-primary btn-small" id="btnAddToCluster" onclick="addSelectedToCluster()" disabled>
                    &#10133; {{ t('create_cluster.add_to_cluster') }}
                </button>
            </div>
        </div>

        <div class="frames-grid library-frames-grid" id="libraryFramesGrid">
            <div class="loading">{{ t('cluster_frames.loading_all') }}</div>
        </div>
    </section>

    <!-- Action Buttons -->
    <section class="section action-buttons-section">
        <div class="action-buttons-container">
            <a href="/video/{{ video_id }}" class="btn btn-secondary btn-large">
                &#10060; {{ t('common.cancel') }}
            </a>
            <button class="btn btn-primary btn-large" id="btnCreateCluster" onclick="createCluster()" disabled>
                &#10003; {{ t('create_cluster.create_button', count='<span id="clusterFrameCount">0</span>') | safe }}
            </button>
        </div>
    </section>
</div>

<!-- Info Modal: References -->
<div id="infoModalReferences" class="modal-overlay">
    <div class="modal-dialog modal-info modal-wide">
        <div class="modal-header">
            <span class="modal-icon">&#9432;</span>
            <span class="modal-title">{{ t('create_cluster.info_refs_title') }}</span>
        </div>
        <div class="modal-body">
            <p>{{ t('create_cluster.info_refs_text') }}</p>
            <ul class="info-list">
                <li>{{ t('create_cluster.info_refs_list1', max=max_refs) }}</li>
                <li>{{ t('create_cluster.info_refs_list2') }}</li>
                <li>{{ t('create_cluster.info_refs_list3') }}</li>
            </ul>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="closeModal('infoModalReferences')">{{ t('create_cluster.understood') }}</button>
        </div>
    </div>
</div>

<!-- Info Modal: Library -->
<div id="infoModalLibrary" class="modal-overlay">
    <div class="modal-dialog modal-info modal-wide">
        <div class="modal-header">
            <span class="modal-icon">&#9432;</span>
            <span class="modal-title">{{ t('create_cluster.info_library_title') }}</span>
        </div>
        <div class="modal-body">
            <p>{{ t('create_cluster.info_library_text') }}</p>
            <h4>{{ t('create_cluster.info_library_actions') }}:</h4>
            <ul class="info-list">
                <li><strong>&#9889; {{ t('create_cluster.add_to_refs') }}:</strong> {{ t('create_cluster.info_library_refs', max=max_refs) }}</li>
                <li><strong>&#10133; {{ t('create_cluster.add_to_cluster') }}:</strong> {{ t('create_cluster.info_library_cluster') }}</li>
            </ul>
            <div class="info-box info-box-hint">
                <strong>&#128161;</strong> {{ t('create_cluster.info_library_hint') }}
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="closeModal('infoModalLibrary')">{{ t('create_cluster.understood') }}</button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    const videoId = {{ video_id }};
    const MAX_REFS = {{ max_refs }};

    // =========================================================================
    // STATE
    // =========================================================================
    let allFrames = [];                    // All frames from API
    let filteredFrames = [];               // Frames after filter applied
    let framesByFilename = new Map();      // filename â†’ frame object (fast lookup)

    let selectedFrames = new Set();        // filenames selected in library
    let clusterFrames = new Set();         // filenames added to the cluster
    let referenceFrames = new Set();       // filenames marked as references

    // =========================================================================
    // INITIALIZATION
    // =========================================================================

    document.addEventListener('DOMContentLoaded', () => {
        loadAllFrames();
        setupEventListeners();
    });

    function setupEventListeners() {
        // Event delegation for library grid
        document.getElementById('libraryFramesGrid')
            .addEventListener('click', handleLibraryGridClick);

        // Event delegation for reference grid
        document.getElementById('referenceFramesGrid')
            .addEventListener('click', handleReferenceGridClick);
    }

    // =========================================================================
    // EVENT HANDLERS (delegated)
    // =========================================================================

    function handleLibraryGridClick(e) {
        const card = e.target.closest('.library-frame-card');
        if (!card) return;

        const filename = card.dataset.filename;
        if (!filename) return;

        // Prevent double-toggle if clicking checkbox directly
        if (e.target.tagName === 'INPUT') {
            e.stopPropagation();
        }

        toggleFrameSelection(filename);
    }

    function handleReferenceGridClick(e) {
        const removeBtn = e.target.closest('.frame-remove-btn');
        if (removeBtn) {
            const card = removeBtn.closest('.reference-frame-card');
            const filename = card?.dataset.filename;
            if (filename) {
                removeFromReferences(filename);
            }
        }
    }

    async function loadAllFrames() {
        try {
            const response = await fetch(`/api/analysis/${videoId}/frames/all?include_assigned=true`);
            if (!response.ok) throw new Error('Error loading frames');

            const data = await response.json();
            allFrames = data.frames;

            // Build lookup map for O(1) access by filename
            framesByFilename.clear();
            allFrames.forEach(frame => {
                framesByFilename.set(frame.filename, frame);
            });

            applyFilter();
            updateCounters();

        } catch (error) {
            console.error('Error loading frames:', error);
            document.getElementById('libraryFramesGrid').innerHTML =
                `<div class="error">${t('errors.load_frames')}: ${error.message}</div>`;
        }
    }

    // =========================================================================
    // FILTERING
    // =========================================================================

    function applyFilter() {
        const filter = document.getElementById('frameFilter').value;

        switch (filter) {
            case 'unassigned':
                filteredFrames = allFrames.filter(f => !f.cluster_id);
                break;
            case 'with_face':
                filteredFrames = allFrames.filter(f => f.quality_score > 0);
                break;
            default:
                filteredFrames = [...allFrames];
        }

        renderLibraryFrames();
        updateCounters();
    }

    // =========================================================================
    // RENDERING
    // =========================================================================

    function renderReferenceFrames() {
        const grid = document.getElementById('referenceFramesGrid');

        if (referenceFrames.size === 0) {
            grid.innerHTML = `<p class="empty-message">${t('empty_state.select_frames_hint')}</p>`;
            return;
        }

        const html = Array.from(referenceFrames)
            .map(filename => {
                const frame = framesByFilename.get(filename);
                if (!frame) return '';
                return createReferenceFrameCard(frame);
            })
            .join('');

        grid.innerHTML = html;
    }

    function renderLibraryFrames() {
        const grid = document.getElementById('libraryFramesGrid');

        if (filteredFrames.length === 0) {
            grid.innerHTML = `<p class="empty-message">${t('empty_state.no_frames_filter')}</p>`;
            return;
        }

        grid.innerHTML = filteredFrames.map(frame => createLibraryFrameCard(frame)).join('');
    }

    function createReferenceFrameCard(frame) {
        const qualityScore = (frame.quality_score || 0) / 10;
        const qualityClass = getQualityClass(frame.quality_score);
        const expressionIcon = getExpressionIcon(frame.expression);

        return `
            <div class="frame-card reference-frame-card" data-filename="${frame.filename}">
                <button class="frame-remove-btn" title="${t('cluster_frames.remove_reference')}">
                    &times;
                </button>
                <img src="/api/analysis/${videoId}/frames/${encodeURIComponent(frame.filename)}/image"
                     alt="${frame.filename}"
                     loading="lazy"
                     onerror="this.src='/static/img/placeholder.svg'">
                <div class="frame-info">
                    <div class="quality-bar ${qualityClass}">
                        <div class="quality-fill" style="width: ${frame.quality_score || 0}%"></div>
                    </div>
                    <div class="frame-meta">
                        <span class="quality-score" title="${t('cluster_frames.quality_score')}">${qualityScore.toFixed(1)}</span>
                        <span class="expression-icon" title="${frame.expression || t('common.unknown')}">${expressionIcon}</span>
                    </div>
                </div>
            </div>
        `;
    }

    function createLibraryFrameCard(frame) {
        const qualityScore = (frame.quality_score || 0) / 10;
        const qualityClass = getQualityClass(frame.quality_score);
        const expressionIcon = getExpressionIcon(frame.expression);
        const isSelected = selectedFrames.has(frame.filename);
        const isInCluster = clusterFrames.has(frame.filename);
        const isInOtherCluster = frame.cluster_id !== null;
        const sceneInfo = extractSceneInfo(frame.filename);

        let statusClass = '';
        let statusIcon = '';
        if (isInCluster) {
            statusClass = 'in-cluster';
            statusIcon = `<span class="frame-status-icon" title="${t('create_cluster.in_cluster')}">${String.fromCharCode(10003)}</span>`;
        } else if (isInOtherCluster) {
            statusClass = 'in-other-cluster';
            statusIcon = `<span class="frame-status-icon" title="${t('cluster_frames.in_other_cluster', {index: frame.cluster_index + 1})}">&#128100;</span>`;
        }

        return `
            <div class="frame-card library-frame-card ${isSelected ? 'selected' : ''} ${statusClass}"
                 data-filename="${frame.filename}">
                <div class="frame-checkbox">
                    <input type="checkbox" ${isSelected ? 'checked' : ''}>
                </div>
                ${statusIcon}
                <img src="/api/analysis/${videoId}/frames/${encodeURIComponent(frame.filename)}/image"
                     alt="${frame.filename}"
                     loading="lazy"
                     onerror="this.src='/static/img/placeholder.svg'">
                <div class="frame-info">
                    <div class="quality-bar ${qualityClass}">
                        <div class="quality-fill" style="width: ${frame.quality_score || 0}%"></div>
                    </div>
                    <div class="frame-meta">
                        <span class="quality-score" title="${t('cluster_frames.quality_score')}">${qualityScore.toFixed(1)}</span>
                        <span class="scene-info" title="${t('cluster_frames.scene_frame')}">${sceneInfo}</span>
                        <span class="expression-icon" title="${frame.expression || t('common.unknown')}">${expressionIcon}</span>
                    </div>
                </div>
            </div>
        `;
    }

    // =========================================================================
    // SELECTION
    // =========================================================================

    function toggleFrameSelection(filename) {
        if (selectedFrames.has(filename)) {
            selectedFrames.delete(filename);
        } else {
            selectedFrames.add(filename);
        }

        // Selective DOM update instead of full re-render
        updateFrameCardState(filename);
        updateCounters();
    }

    function updateFrameCardState(filename) {
        const card = document.querySelector(
            `.library-frame-card[data-filename="${CSS.escape(filename)}"]`
        );
        if (!card) return;

        const isSelected = selectedFrames.has(filename);
        const isInCluster = clusterFrames.has(filename);

        // Update selected state
        card.classList.toggle('selected', isSelected);

        // Update checkbox
        const checkbox = card.querySelector('input[type="checkbox"]');
        if (checkbox) checkbox.checked = isSelected;

        // Update cluster status
        card.classList.toggle('in-cluster', isInCluster);

        // Update status icon if needed
        if (isInCluster && !card.querySelector('.frame-status-icon')) {
            const icon = document.createElement('span');
            icon.className = 'frame-status-icon';
            icon.title = t('create_cluster.in_cluster');
            icon.innerHTML = '&#10003;';
            card.insertBefore(icon, card.querySelector('img'));
        }
    }

    function toggleSelectAll() {
        const selectAllCb = document.getElementById('selectAllLibrary');
        if (selectAllCb.checked) {
            filteredFrames.forEach(f => selectedFrames.add(f.filename));
        } else {
            selectedFrames.clear();
        }
        renderLibraryFrames();
        updateCounters();
    }

    // =========================================================================
    // ACTIONS
    // =========================================================================

    function addSelectedToCluster() {
        if (selectedFrames.size === 0) return;

        const filenames = Array.from(selectedFrames);
        filenames.forEach(filename => {
            clusterFrames.add(filename);
        });

        selectedFrames.clear();

        // Update visual state for affected frames
        filenames.forEach(filename => updateFrameCardState(filename));
        updateCounters();
        ThumbnailApp.showToast(t('create_cluster.added_to_cluster'), 'success');
    }

    function addSelectedToReferences() {
        if (selectedFrames.size === 0) return;

        let added = 0;
        const filenames = Array.from(selectedFrames);

        filenames.forEach(filename => {
            if (referenceFrames.size < MAX_REFS && !referenceFrames.has(filename)) {
                referenceFrames.add(filename);
                // Also add to cluster if not already
                clusterFrames.add(filename);
                added++;
            }
        });

        selectedFrames.clear();

        // Update visual state for affected frames
        filenames.forEach(filename => updateFrameCardState(filename));
        renderReferenceFrames();
        updateCounters();

        if (added > 0) {
            ThumbnailApp.showToast(t('create_cluster.added_to_refs', {count: added}), 'success');
        } else {
            ThumbnailApp.showToast(t('create_cluster.max_reached', {max: MAX_REFS}), 'warning');
        }
    }

    function removeFromReferences(filename) {
        referenceFrames.delete(filename);
        renderReferenceFrames();
        updateCounters();
    }

    function clearReferences() {
        referenceFrames.clear();
        renderReferenceFrames();
        updateCounters();
    }

    // Helper function to convert filenames to paths for API calls
    function filenamesToPaths(filenames) {
        return Array.from(filenames)
            .map(filename => framesByFilename.get(filename)?.path)
            .filter(Boolean);
    }

    async function createCluster() {
        if (clusterFrames.size === 0) {
            ThumbnailApp.showToast(t('errors.select_at_least_one_frame'), 'error');
            return;
        }

        const clusterName = document.getElementById('clusterName').value.trim() || null;
        const clusterDescription = document.getElementById('clusterDescription').value.trim() || null;

        // Convert filenames to paths for the API
        const framePaths = filenamesToPaths(clusterFrames);
        const refPaths = referenceFrames.size > 0 ? filenamesToPaths(referenceFrames) : null;

        if (framePaths.length === 0) {
            ThumbnailApp.showToast(t('errors.frames_not_found'), 'error');
            return;
        }

        // Disable button while creating
        const btn = document.getElementById('btnCreateCluster');
        btn.disabled = true;
        btn.innerHTML = `&#8987; ${t('create_cluster.creating')}`;

        try {
            const response = await fetch(`/api/analysis/${videoId}/clusters/create`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    frame_paths: framePaths,
                    label: clusterName,
                    description: clusterDescription,
                    reference_frame_paths: refPaths
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Error creating cluster');
            }

            const data = await response.json();
            ThumbnailApp.showToast(t('create_cluster.created_success', {count: data.cluster.num_frames}), 'success');

            // Redirect back to video detail page
            setTimeout(() => {
                window.location.href = `/video/${videoId}`;
            }, 1000);

        } catch (error) {
            ThumbnailApp.showToast(t('common.error') + ': ' + error.message, 'error');
            btn.disabled = false;
            btn.innerHTML = `&#10003; ${t('create_cluster.create_button', {count: clusterFrames.size})}`;
        }
    }

    // =========================================================================
    // COUNTERS & UI UPDATES
    // =========================================================================

    function updateCounters() {
        // Frames count
        document.getElementById('framesCount').textContent = `(${filteredFrames.length})`;

        // Reference counter
        document.getElementById('refCounter').textContent = `(${referenceFrames.size}/${MAX_REFS})`;

        // Selection info
        const selCount = selectedFrames.size;
        document.getElementById('librarySelectionInfo').textContent =
            t('selection.selected_count', {count: selCount});

        // Button states
        const btnAddToRefs = document.getElementById('btnAddToRefs');
        const btnAddToCluster = document.getElementById('btnAddToCluster');
        const btnClearRefs = document.getElementById('btnClearRefs');
        const btnCreateCluster = document.getElementById('btnCreateCluster');

        btnAddToRefs.disabled = selCount === 0 || referenceFrames.size >= MAX_REFS;
        btnAddToCluster.disabled = selCount === 0;
        btnClearRefs.disabled = referenceFrames.size === 0;
        btnCreateCluster.disabled = clusterFrames.size === 0;

        // Update create button text
        document.getElementById('clusterFrameCount').textContent = clusterFrames.size;

        // Select all checkbox state
        const selectAllCb = document.getElementById('selectAllLibrary');
        selectAllCb.checked = selCount === filteredFrames.length && selCount > 0;
        selectAllCb.indeterminate = selCount > 0 && selCount < filteredFrames.length;
    }

    // =========================================================================
    // HELPERS
    // =========================================================================

    function extractSceneInfo(filename) {
        if (!filename) return '';
        const match = filename.match(/scene_(\d+)_frame_(\d+)/);
        if (match) {
            return `S${parseInt(match[1])}:F${parseInt(match[2])}`;
        }
        return '';
    }

    function getQualityClass(score) {
        if (score >= 90) return 'quality-excellent';
        if (score >= 75) return 'quality-good';
        if (score >= 60) return 'quality-fair';
        if (score >= 40) return 'quality-poor';
        return 'quality-bad';
    }

    function getExpressionIcon(expression) {
        const icons = {
            'smiling': '&#128522;',
            'neutral': '&#128528;',
            'mouth_closed': '&#128566;',
            'mouth_open': '&#128558;'
        };
        return icons[expression] || '&#128528;';
    }

    // =========================================================================
    // MODALS
    // =========================================================================

    function showInfoModal(type) {
        const modalId = type === 'references' ? 'infoModalReferences' : 'infoModalLibrary';
        document.getElementById(modalId).classList.add('visible');
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('visible');
    }
</script>
{% endblock %}
