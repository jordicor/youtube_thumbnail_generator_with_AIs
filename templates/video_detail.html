{% extends "base.html" %}

{% block title %}Video Detail - Thumbnail Generator{% endblock %}

{% block content %}
<div class="page-header">
    <a href="/" class="back-link">&larr; Volver a videos</a>
    <h1 id="videoTitle">Cargando...</h1>
</div>

<div class="video-detail" id="videoDetailApp" data-video-id="{{ video_id }}">
    <!-- Video info section -->
    <section class="section">
        <h2>Informacion del Video</h2>
        <div id="videoInfo" class="video-info-card">
            <div class="loading">Cargando informacion...</div>
        </div>
    </section>

    <!-- Transcription section (Collapsible) -->
    <section class="section transcription-section" id="transcriptionSection" style="display: none;">
        <div class="section-header-collapsible" onclick="VideoDetail.toggleSection('transcriptionContent')">
            <h2>
                <span class="collapse-icon" id="transcriptionContentIcon">&#9660;</span>
                Transcripcion del Video
            </h2>
        </div>
        <div id="transcriptionContent" class="collapsible-content">
            <div class="transcription-container">
                <div id="transcriptionText" class="transcription-text">
                    <div class="loading">Cargando transcripcion...</div>
                </div>
            </div>
        </div>
    </section>

    <!-- Clusters section -->
    <section class="section">
        <div class="section-header-row">
            <h2 class="section-title">Personas/Personajes Detectados <span class="info-tooltip" data-tooltip="Grupos de imagenes de cada persona detectada en el video. Usa la ‚òÜ para seleccionar cual aparecera en las miniaturas. Haz clic en ‚öô para editar el cluster y anadir detalles (nombre, descripcion, etc.).">&#9432;</span></h2>
            <div class="cluster-view-selector">
                <label for="clusterViewType">Ver como:</label>
                <select id="clusterViewType" onchange="VideoDetail.changeClusterViewType()">
                    <option value="person" selected>Por Persona</option>
                    <option value="person_scene">Por Persona + Escena</option>
                </select>
            </div>
        </div>

        <!-- Selection bar -->
        <div id="clusterSelectionBar" class="selection-bar visible">
            <div class="selection-bar-left">
                <label class="checkbox-wrapper">
                    <input type="checkbox" id="selectAllClusters" onchange="VideoDetail.toggleSelectAllClusters()">
                    <span>Seleccionar todos</span>
                </label>
                <span id="clusterSelectionCount" class="selection-count">0 seleccionados</span>
            </div>
            <div class="selection-bar-right">
                <a href="/video/{{ video_id }}/cluster/create" class="btn btn-secondary btn-create-cluster" title="Crear cluster manualmente">
                    + Nuevo
                </a>
                <button id="btnMergeClusters" class="btn btn-secondary" onclick="VideoDetail.showMergeModal()" disabled>
                    Fusionar
                </button>
                <button id="btnDeleteSelectedClusters" class="btn btn-danger" onclick="VideoDetail.showDeleteSelectedModal()" disabled>
                    Eliminar
                </button>
            </div>
        </div>

        <div id="clustersGridContainer" class="clusters-grid-container">
            <div id="clustersGrid" class="clusters-grid">
                <div class="loading">Cargando clusters...</div>
            </div>
        </div>
    </section>

    <!-- Delete Cluster Modal -->
    <div id="deleteClusterModal" class="modal-overlay">
        <div class="modal-dialog modal-danger">
            <div class="modal-header">
                <span class="modal-icon">&#9888;</span>
                <span class="modal-title">Eliminar Cluster</span>
            </div>
            <div class="modal-body">
                <p id="deleteClusterMessage">¬øEliminar este cluster? Se perderan los frames asociados.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancel" onclick="VideoDetail.closeModal('deleteClusterModal')">Cancelar</button>
                <button class="btn btn-confirm" id="confirmDeleteBtn" onclick="VideoDetail.confirmDeleteCluster()">Eliminar</button>
            </div>
        </div>
    </div>

    <!-- Merge Clusters Modal -->
    <div id="mergeClustersModal" class="modal-overlay">
        <div class="modal-dialog modal-info">
            <div class="modal-header">
                <span class="modal-icon">&#8644;</span>
                <span class="modal-title">Fusionar Clusters</span>
            </div>
            <div class="modal-body">
                <p>Se fusionaran <strong id="mergeCount">0</strong> clusters en uno solo.</p>
                <p style="margin-top: 10px;">Selecciona cual sera el principal (su imagen se usara como representativa):</p>
                <div id="mergeTargetOptions" class="merge-target-options" style="margin-top: 15px;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancel" onclick="VideoDetail.closeModal('mergeClustersModal')">Cancelar</button>
                <button class="btn btn-confirm" onclick="VideoDetail.confirmMergeClusters()">Fusionar</button>
            </div>
        </div>
    </div>

    <!-- AI Configuration Chips Bar -->
    <div class="ai-config-bar" id="aiConfigBar">
        <span class="ai-config-bar-label">Configuracion IA:</span>

        <!-- Overlay for closing popovers -->
        <div class="ai-config-overlay" id="aiConfigOverlay" onclick="VideoDetail.closeAllAiPopovers()"></div>

        <!-- Text AI Chip -->
        <div class="ai-config-chip-wrapper">
            <div class="ai-config-chip" id="textAiChip" onclick="VideoDetail.toggleAiPopover('textAi')">
                <span class="ai-config-chip-icon">&#129302;</span>
                <div class="ai-config-chip-content">
                    <span class="ai-config-chip-title">IA Texto</span>
                    <span class="ai-config-chip-value" id="textAiChipValue">
                        Claude 3.5
                        <span class="ai-config-chip-badge" id="textAiThinkingBadge" style="display: none;">Think</span>
                    </span>
                </div>
                <span class="ai-config-chip-arrow">&#9660;</span>
            </div>

            <!-- Text AI Popover -->
            <div class="ai-config-popover" id="textAiPopover">
                <div class="ai-config-popover-header">
                    <span class="ai-config-popover-title">&#129302; Configurar IA para Textos</span>
                    <button class="ai-config-popover-close" onclick="VideoDetail.closeAiPopover('textAi')">&times;</button>
                </div>
                <div class="ai-config-popover-body">
                    <div class="form-group">
                        <label for="textAiProvider">Motor IA:</label>
                        <select id="textAiProvider" onchange="VideoDetail.updateTextAiModelOptions()">
                            <option value="anthropic">Anthropic (Claude)</option>
                            <option value="openai">OpenAI (GPT)</option>
                            <option value="google">Google (Gemini)</option>
                            <option value="xai">xAI (Grok)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="textAiModel">Modelo:</label>
                        <select id="textAiModel">
                            <option value="">Cargando modelos...</option>
                        </select>
                    </div>
                    <div class="ai-config-thinking-row">
                        <label class="ai-config-thinking-toggle">
                            <input type="checkbox" id="textAiThinkingEnabled" onchange="VideoDetail.toggleTextAiThinkingLevel()">
                            <span>Thinking mode</span>
                        </label>
                        <div class="ai-config-thinking-level hidden" id="textAiThinkingLevelGroup">
                            <label for="textAiThinkingLevel">Nivel:</label>
                            <select id="textAiThinkingLevel">
                                <option value="low">Bajo</option>
                                <option value="medium" selected>Medio</option>
                                <option value="high">Alto</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="ai-config-popover-info">
                    <span class="ai-config-popover-info-icon">&#9432;</span>
                    <span>Esta configuracion se usa para generar titulos, descripciones y prompts de imagenes.</span>
                </div>
            </div>
        </div>

        <!-- Image AI Chip -->
        <div class="ai-config-chip-wrapper">
            <div class="ai-config-chip" id="imageAiChip" onclick="VideoDetail.toggleAiPopover('imageAi')">
                <span class="ai-config-chip-icon">&#128247;</span>
                <div class="ai-config-chip-content">
                    <span class="ai-config-chip-title">IA Imagenes</span>
                    <span class="ai-config-chip-value" id="imageAiChipValue">
                        Gemini Flash
                        <span class="ai-config-chip-badge" id="imageAiRefBadge">3 refs</span>
                    </span>
                </div>
                <span class="ai-config-chip-arrow">&#9660;</span>
            </div>

            <!-- Image AI Popover -->
            <div class="ai-config-popover ai-config-popover-wide" id="imageAiPopover">
                <div class="ai-config-popover-header">
                    <span class="ai-config-popover-title">&#128247; Configurar Generador de Imagenes</span>
                    <button class="ai-config-popover-close" onclick="VideoDetail.closeAiPopover('imageAi')">&times;</button>
                </div>
                <div class="ai-config-popover-body">
                    <div class="form-group">
                        <label for="imageAiProvider">Proveedor:</label>
                        <select id="imageAiProvider" onchange="VideoDetail.updateImageAiModelOptions(true)">
                            <option value="gemini">Gemini (Google)</option>
                            <option value="poe">Poe (FLUX/Ideogram)</option>
                            <option value="openai">OpenAI</option>
                            <option value="replicate">Replicate</option>
                        </select>
                        <small class="ai-config-ref-indicator supported" id="imageAiRefIndicator">Soporta imagenes de referencia</small>
                    </div>

                    <!-- Gemini Model -->
                    <div class="ai-config-model-subsection" id="imageAiGeminiModelGroup">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="imageAiGeminiModel">Modelo:</label>
                            <select id="imageAiGeminiModel" onchange="VideoDetail.updateImageAiRefMax(true)">
                                <option value="gemini-2.5-flash-image">gemini-2.5-flash-image (Rapido)</option>
                                <option value="gemini-3-pro-image-preview">gemini-3-pro-image-preview (4K)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Poe Model -->
                    <div class="ai-config-model-subsection" id="imageAiPoeModelGroup" style="display: none;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="imageAiPoeModel">Modelo:</label>
                            <select id="imageAiPoeModel" onchange="VideoDetail.updateImageAiRefMax(true)">
                                <option value="flux2pro">flux2pro - Mejor calidad</option>
                                <option value="flux2flex">flux2flex - Alta resolucion</option>
                                <option value="fluxkontextpro">fluxkontextpro - Mejor prompt</option>
                                <option value="seedream40">seedream40 - Combinar refs</option>
                                <option value="nanobananapro">nanobananapro - Gemini 3</option>
                                <option value="Ideogram-v3">Ideogram-v3 - Texto/logos</option>
                            </select>
                        </div>
                    </div>

                    <!-- OpenAI Model -->
                    <div class="ai-config-model-subsection" id="imageAiOpenaiModelGroup" style="display: none;">
                        <div class="warning-box" id="imageAiOpenaiWarning" style="display: none; margin-bottom: 10px;">
                            <strong>AVISO:</strong> DALL-E 3 NO soporta refs.
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="imageAiOpenaiModel">Modelo:</label>
                            <select id="imageAiOpenaiModel" onchange="VideoDetail.updateImageAiOpenaiWarning(); VideoDetail.updateImageAiRefMax(true)">
                                <option value="gpt-image-1.5" data-ref="true">gpt-image-1.5 - Mejor</option>
                                <option value="gpt-image-1" data-ref="true">gpt-image-1 - Estandar</option>
                                <option value="gpt-image-1-mini" data-ref="true">gpt-image-1-mini - Rapido</option>
                                <option value="dall-e-3" data-ref="false">dall-e-3 - Sin refs</option>
                            </select>
                        </div>
                    </div>

                    <!-- Reference Images -->
                    <div class="form-group" id="imageAiRefGroup" style="margin-top: 14px;">
                        <label for="imageAiNumRefs">
                            Imagenes de referencia <span id="imageAiRefMaxLabel" class="ref-max-label">(max. 3)</span>
                        </label>
                        <input type="number" id="imageAiNumRefs" value="3" min="1" max="3">
                    </div>
                </div>
            </div>
        </div>

        <!-- Gran Sabio LLM Status -->
        <span class="gransabio-status unavailable" id="gransabioStatusChip" title="Estado de Gran Sabio LLM">
            <span class="status-dot"></span>
            <span class="status-text">Offline</span>
        </span>
    </div>

    <!-- Content Optimization Section (Collapsible with Tabs) -->
    <section class="section content-optimization-section">
        <div class="section-header-collapsible" onclick="VideoDetail.toggleSection('contentSection')">
            <h2>
                <span class="collapse-icon" id="contentSectionIcon">&#9660;</span>
                Optimizacion de Contenido
            </h2>
        </div>

        <div id="contentSection" class="collapsible-content">
            <!-- Tabs -->
            <div class="content-tabs">
                <button class="tab-btn active" onclick="VideoDetail.switchContentTab('titles')" id="tabTitles">
                    Titulos
                </button>
                <button class="tab-btn" onclick="VideoDetail.switchContentTab('descriptions')" id="tabDescriptions">
                    Descripciones
                </button>
            </div>

            <!-- Tab Content: Titles -->
            <div id="tabContentTitles" class="tab-content active">
                <div class="content-generation-form content-generation-form-simplified">
                    <div class="form-section">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="titleStyle">Estilo: <span class="info-tooltip" data-tooltip="Neutro: descriptivo y claro. SEO: con palabras clave para busquedas. Clickbait: llamativo con gancho emocional.">&#9432;</span></label>
                                <select id="titleStyle" onchange="VideoDetail.updateTitleStyleUI()">
                                    <option value="neutral">Neutro - Claros y descriptivos</option>
                                    <option value="seo">SEO - Optimizado para busquedas</option>
                                    <option value="clickbait">Clickbait - Llamativo y con gancho</option>
                                    <option value="custom">Personalizado</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="titleLanguage">Idioma:</label>
                                <select id="titleLanguage">
                                    <option value="es" selected>Espanol</option>
                                    <option value="en">English</option>
                                    <option value="fr">Francais</option>
                                    <option value="it">Italiano</option>
                                    <option value="de">Deutsch</option>
                                    <option value="pt">Portugues</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="titleQuantity">Cantidad:</label>
                                <input type="number" id="titleQuantity" value="5" min="1" max="50">
                            </div>
                        </div>

                        <div class="form-group" id="customPromptGroup" style="display: none;">
                            <label for="titleCustomPrompt">Prompt personalizado:</label>
                            <textarea id="titleCustomPrompt" rows="3" placeholder="Describe como quieres que sean los titulos..."></textarea>
                        </div>

                        <div class="form-group" id="customInstructionsGroup">
                            <label for="titleCustomInstructions">Instrucciones adicionales (opcional):</label>
                            <textarea id="titleCustomInstructions" rows="2" placeholder="Ej: Incluir el nombre del canal, mencionar que es un tutorial..."></textarea>
                        </div>

                        <button type="button" class="btn btn-primary" id="generateTitlesBtn" onclick="VideoDetail.generateTitles()">
                            Generar Titulos
                        </button>
                    </div>

                    <div class="titles-results-section" id="titlesResultsSection" style="display: none;">
                        <div class="titles-results-header">
                            <h4>Titulos <span id="titlesCount" class="titles-count"></span></h4>
                            <div class="titles-header-actions">
                                <span id="titlesSelectionInfo" class="titles-selection-info" title="Los titulos seleccionados orientaran la generacion de imagenes">
                                    Selecciona titulos para orientar las imagenes
                                </span>
                                <div class="titles-action-buttons">
                                    <button class="btn btn-small btn-secondary" id="selectAllTitlesBtn" onclick="VideoDetail.toggleSelectAllTitles()" title="Seleccionar todos">
                                        &#9744; Todos
                                    </button>
                                    <button class="btn btn-small btn-delete-selected" id="deleteSelectedTitlesBtn" onclick="VideoDetail.deleteSelectedTitles()" title="Eliminar seleccionados">
                                        &#128465; Eliminar
                                    </button>
                                    <button class="btn btn-small btn-secondary" onclick="VideoDetail.copyAllTitles()" title="Copiar todos">
                                        &#128203; Copiar
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="titlesResultsList" class="titles-results-list"></div>
                        <p class="titles-hint">
                            <span class="info-icon">&#9432;</span>
                            Haz clic en un titulo para seleccionarlo. Los titulos seleccionados orientaran la IA al generar thumbnails.
                        </p>
                    </div>

                    <div class="content-loading" id="titlesLoading" style="display: none;">
                        <div class="loading-spinner"></div>
                        <div class="content-loading-text">
                            <span id="titlesLoadingMain">Preparando...</span>
                            <small id="titlesLoadingHint"></small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab Content: Descriptions -->
            <div id="tabContentDescriptions" class="tab-content">
                <div class="content-generation-form content-generation-form-simplified">
                    <div class="form-section">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="descStyle">Estilo:</label>
                                <select id="descStyle" onchange="VideoDetail.updateDescStyleUI()">
                                    <option value="informative">Informativa - Completa y profesional</option>
                                    <option value="seo">SEO - Optimizada para busquedas</option>
                                    <option value="minimal">Minimalista - Breve y directa</option>
                                    <option value="custom">Personalizado</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="descLanguage">Idioma:</label>
                                <select id="descLanguage">
                                    <option value="es" selected>Espanol</option>
                                    <option value="en">English</option>
                                    <option value="fr">Francais</option>
                                    <option value="it">Italiano</option>
                                    <option value="de">Deutsch</option>
                                    <option value="pt">Portugues</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="descLength">Longitud:</label>
                                <select id="descLength">
                                    <option value="short">Corta (~200 car.)</option>
                                    <option value="medium" selected>Media (~500 car.)</option>
                                    <option value="long">Larga (~1000 car.)</option>
                                    <option value="very_long">Muy larga (~2000 car.)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="descQuantity">Cantidad:</label>
                                <input type="number" id="descQuantity" value="1" min="1" max="3">
                            </div>
                        </div>

                        <!-- Checkboxes for extra options -->
                        <div class="form-group">
                            <label>Opciones adicionales:</label>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="descTimestamps">
                                    <span>Incluir timestamps <span class="info-tooltip" data-tooltip="Anade marcas de tiempo (ej: 0:00 Intro, 2:30 Tema principal) para que los espectadores naveguen por el video.">&#9432;</span></span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="descHashtags">
                                    <span>Incluir hashtags</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="descEmojis">
                                    <span>Incluir emojis</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="descSocialLinks">
                                    <span>Incluir redes sociales</span>
                                </label>
                            </div>
                        </div>

                        <div class="form-group" id="descCustomPromptGroup" style="display: none;">
                            <label for="descCustomPrompt">Prompt personalizado:</label>
                            <textarea id="descCustomPrompt" rows="3" placeholder="Describe como quieres que sea la descripcion..."></textarea>
                        </div>

                        <div class="form-group" id="descCustomInstructionsGroup">
                            <label for="descCustomInstructions">Instrucciones adicionales (opcional):</label>
                            <textarea id="descCustomInstructions" rows="2" placeholder="Ej: Mencionar el patrocinador, incluir disclaimer..."></textarea>
                        </div>

                        <button type="button" class="btn btn-primary" id="generateDescBtn" onclick="VideoDetail.generateDescriptions()">
                            Generar Descripciones
                        </button>
                    </div>

                    <div class="form-section descriptions-results-section" id="descriptionsResultsSection" style="display: none;">
                        <div class="descriptions-results-header">
                            <h4>Descripciones <span id="descriptionsCount" class="descriptions-count"></span></h4>
                            <div class="descriptions-header-actions">
                                <div class="descriptions-action-buttons">
                                    <button class="btn btn-small btn-delete-selected" id="deleteAllDescriptionsBtn" onclick="VideoDetail.deleteAllDescriptions()" title="Eliminar todas">
                                        &#128465; Eliminar
                                    </button>
                                    <button class="btn btn-small btn-secondary" onclick="VideoDetail.copyAllDescriptions()" title="Copiar todas">
                                        &#128203; Copiar
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="descriptionsResultsList" class="descriptions-results-list"></div>
                    </div>

                    <div class="content-loading" id="descriptionsLoading" style="display: none;">
                        <div class="loading-spinner"></div>
                        <div class="content-loading-text">
                            <span id="descriptionsLoadingMain">Preparando...</span>
                            <small id="descriptionsLoadingHint"></small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Generation form -->
    <section class="section">
        <h2>Generar Thumbnails</h2>
        <form id="generateForm" class="generate-form generate-form-simplified">
            <div class="form-group cluster-select-group">
                <label>Persona/Personaje: <span class="info-tooltip" data-tooltip="La IA usara estas imagenes como referencia para generar las miniaturas, manteniendo el mismo rostro, peinado, ropa y aspecto general. Selecciona arriba (con ‚òÜ) el personaje que quieras que aparezca en el thumbnail.">&#9432;</span></label>
                <div id="selectedClusterDisplay" class="selected-cluster-display">
                    <span class="no-selection">&#9734; Selecciona un cluster arriba usando la estrella</span>
                </div>
                <select id="clusterSelect" required style="display: none;">
                    <option value="">Selecciona un cluster</option>
                </select>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="numPrompts">Conceptos: <span class="info-tooltip" data-tooltip="Ideas creativas diferentes que la IA generara basandose en el contenido del video.">&#9432;</span></label>
                    <input type="number" id="numPrompts" value="5" min="1" max="50">
                </div>
                <div class="form-group">
                    <label for="numVariations">Variaciones: <span class="info-tooltip" data-tooltip="Versiones diferentes de cada concepto. Util para elegir la mejor composicion.">&#9432;</span></label>
                    <input type="number" id="numVariations" value="1" min="1" max="50">
                </div>
                <div class="form-group">
                    <label for="expression">Expresion:</label>
                    <select id="expression">
                        <option value="">Automatico</option>
                        <option value="smiling">Sonriendo</option>
                        <option value="mouth_closed">Boca cerrada</option>
                        <option value="neutral">Neutral</option>
                    </select>
                </div>
            </div>

            <div class="form-row" style="margin-top: 10px;">
                <label class="checkbox-label">
                    <input type="checkbox" id="promptIncludeHistory">
                    <span>Evitar repetir conceptos previos</span>
                </label>
            </div>

            <!-- Reference Image Section -->
            <div class="form-group reference-image-group" style="margin-top: 15px;">
                <label for="referenceImageInput">
                    Imagen de referencia (opcional):
                    <span class="info-tooltip" data-tooltip="Sube una imagen para que la IA la use como inspiracion visual al crear los conceptos y/o como referencia de estilo para la generacion.">&#9432;</span>
                </label>

                <div class="reference-image-upload">
                    <input type="file" id="referenceImageInput" accept="image/*" style="display: none;">
                    <button type="button" class="btn btn-secondary btn-small" onclick="document.getElementById('referenceImageInput').click()">
                        &#128247; Seleccionar imagen
                    </button>
                    <span id="referenceImageName" class="reference-image-name">Ninguna imagen seleccionada</span>
                </div>

                <div id="referenceImagePreview" class="reference-image-preview" style="display: none;">
                    <img id="referenceImageImg" src="" alt="Preview">
                    <button type="button" id="clearReferenceImage" class="reference-image-clear"
                            onclick="VideoDetail.clearReferenceImage()" title="Quitar imagen">
                        &#10005;
                    </button>
                </div>

                <div id="referenceImageOptions" class="reference-image-options" style="display: none; margin-top: 10px;">
                    <label class="checkbox-label">
                        <input type="checkbox" id="useRefForPrompts" checked>
                        <span>Analizar para prompts <span class="info-tooltip" data-tooltip="La IA de texto analizara esta imagen antes de crear los conceptos, usandola como inspiracion visual.">&#9432;</span></span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="includeRefInImages">
                        <span>Incluir como referencia de estilo <span class="info-tooltip" data-tooltip="La imagen se enviara junto con las referencias del cluster a la IA de imagenes. Si se alcanza el limite, se quitara la ultima referencia del cluster.">&#9432;</span></span>
                    </label>
                </div>
            </div>

            <!-- Custom Instructions (at the end, as they override everything) -->
            <div class="form-group" style="margin-top: 15px;">
                <label for="promptCustomInstructions">
                    Instrucciones para los prompts (opcional):
                    <span class="info-tooltip" data-tooltip="Instrucciones globales para la IA. Prevalecen sobre todo lo demas. Puedes indicar estilo, composicion, fondos, estetica, o cualquier detalle especifico. Si has subido una imagen de referencia, puedes dar instrucciones sobre como usarla.">&#9432;</span>
                </label>
                <textarea id="promptCustomInstructions" class="custom-instructions-textarea" placeholder="Ej: Estilo YouTube 2016, borde blanco, fondo kawaii, expresion exagerada..."></textarea>
            </div>

            <button type="submit" class="btn btn-primary btn-large" style="width: 100%; max-width: 400px; margin: 20px auto 0; display: block;">
                Generar Thumbnails
            </button>
        </form>
    </section>

    <!-- Generation status -->
    <section class="section hidden" id="generationStatus">
        <h2>Progreso de Generacion</h2>
        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <p id="progressText">Iniciando...</p>
        </div>
    </section>

    <!-- Results (shown during/after generation) -->
    <section class="section hidden" id="resultsSection">
        <h2>Generando Thumbnails...</h2>
        <div id="thumbnailsGrid" class="thumbnails-grid"></div>
    </section>

    <!-- Existing Thumbnails Gallery -->
    <section class="section" id="existingThumbnailsSection">
        <div class="section-header-with-actions">
            <h2>
                <span>Miniaturas Guardadas</span>
                <span class="thumbnail-count-badge" id="thumbnailCountBadge">0</span>
            </h2>
            <div class="section-actions">
                <button class="btn btn-secondary btn-small" id="downloadAllBtn" onclick="VideoDetail.downloadAllThumbnails()" style="display: none;">
                    &#128230; Descargar todas
                </button>
            </div>
        </div>
        <div class="existing-thumbnails-wrapper" id="existingThumbnailsWrapper">
            <div class="existing-thumbnails-container" id="existingThumbnailsContainer">
                <div class="existing-thumbnails-grid" id="existingThumbnailsGrid">
                    <div class="loading">Cargando miniaturas...</div>
                </div>
            </div>
        </div>
        <div class="no-thumbnails-message" id="noThumbnailsMessage" style="display: none;">
            <div class="empty-state">
                <span class="empty-icon">üñºÔ∏è</span>
                <p>No hay miniaturas generadas todavia</p>
                <small>Configura las opciones arriba y genera tu primera miniatura</small>
            </div>
        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script type="module" src="/static/js/video_detail/main.js"></script>
{% endblock %}
