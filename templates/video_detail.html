{% extends "base.html" %}

{% block title %}{{ t('video_detail.title') }} - {{ t('common.app_name') }}{% endblock %}

{% block content %}
<div class="page-header">
    <a href="/" class="back-link">&larr; {{ t('video_detail.back_to_list') }}</a>
    <h1 id="videoTitle">{{ t('common.loading') }}</h1>
</div>

<div class="video-detail" id="videoDetailApp" data-video-id="{{ video_id }}">
    <!-- Analysis Overlay - shown when video is being analyzed -->
    <div id="analysisOverlay" class="analysis-overlay hidden">
        <div class="analysis-overlay-content">
            <div class="analysis-overlay-icon">üîç</div>
            <h2 id="analysisOverlayTitle">{{ t('analysis_overlay.title') }}</h2>
            <div class="analysis-progress-bar">
                <div class="analysis-progress-fill" id="analysisProgressFill"></div>
            </div>
            <p class="analysis-step" id="analysisStep">{{ t('analysis_overlay.starting') }}</p>
            <p class="analysis-percent" id="analysisPercent">0%</p>
            <button class="btn btn-danger" id="cancelAnalysisBtn">{{ t('analysis_overlay.cancel') }}</button>
        </div>
    </div>

    <!-- Video info section -->
    <section class="section">
        <h2>{{ t('video_detail.info.title') }}</h2>
        <div id="videoInfo" class="video-info-card">
            <div class="loading">{{ t('common.loading') }}</div>
        </div>
    </section>

    <!-- Transcription section (Collapsible) -->
    <section class="section transcription-section" id="transcriptionSection" style="display: none;">
        <div class="section-header-collapsible" onclick="VideoDetail.toggleSection('transcriptionContent')">
            <h2>
                <span class="collapse-icon" id="transcriptionContentIcon">&#9660;</span>
                {{ t('transcription.title') }}
            </h2>
        </div>
        <div id="transcriptionContent" class="collapsible-content">
            <div class="transcription-container">
                <div id="transcriptionText" class="transcription-text">
                    <div class="loading">{{ t('transcription.loading') }}</div>
                </div>
            </div>
        </div>
    </section>

    <!-- Clusters section -->
    <section class="section">
        <div class="section-header-row">
            <h2 class="section-title">{{ t('clusters.title') }} <span class="info-tooltip" data-tooltip="{{ t('clusters.tooltip') }}">&#9432;</span></h2>
            <div class="cluster-view-selector">
                <label for="clusterViewType">{{ t('clusters.view_as') }}</label>
                <select id="clusterViewType" onchange="VideoDetail.changeClusterViewType()">
                    <option value="person" selected>{{ t('clusters.by_person') }}</option>
                    <option value="person_scene">{{ t('clusters.by_person_scene') }}</option>
                </select>
            </div>
        </div>

        <!-- Selection bar -->
        <div id="clusterSelectionBar" class="selection-bar visible">
            <div class="selection-bar-left">
                <label class="checkbox-wrapper">
                    <input type="checkbox" id="selectAllClusters" onchange="VideoDetail.toggleSelectAllClusters()">
                    <span>{{ t('common.select_all') }}</span>
                </label>
                <span id="clusterSelectionCount" class="selection-count">{{ t('selection.selected_count', count=0) }}</span>
            </div>
            <div class="selection-bar-right">
                <a href="/video/{{ video_id }}/cluster/create" class="btn btn-secondary btn-create-cluster" title="{{ t('clusters.create_cluster') }}">
                    {{ t('clusters.new') }}
                </a>
                <button id="btnMergeClusters" class="btn btn-secondary" onclick="VideoDetail.showMergeModal()" disabled>
                    {{ t('clusters.merge') }}
                </button>
                <button id="btnDeleteSelectedClusters" class="btn btn-danger" onclick="VideoDetail.showDeleteSelectedModal()" disabled>
                    {{ t('common.delete') }}
                </button>
            </div>
        </div>

        <div id="clustersGridContainer" class="clusters-grid-container">
            <div id="clustersGrid" class="clusters-grid">
                <div class="loading">{{ t('clusters.loading') }}</div>
            </div>
        </div>
    </section>

    <!-- Delete Cluster Modal -->
    <div id="deleteClusterModal" class="modal-overlay">
        <div class="modal-dialog modal-danger">
            <div class="modal-header">
                <span class="modal-icon">&#9888;</span>
                <span class="modal-title">{{ t('clusters.delete_title') }}</span>
            </div>
            <div class="modal-body">
                <p id="deleteClusterMessage">{{ t('clusters.delete_message') }}</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancel" onclick="VideoDetail.closeModal('deleteClusterModal')">{{ t('common.cancel') }}</button>
                <button class="btn btn-confirm" id="confirmDeleteBtn" onclick="VideoDetail.confirmDeleteCluster()">{{ t('common.delete') }}</button>
            </div>
        </div>
    </div>

    <!-- Merge Clusters Modal -->
    <div id="mergeClustersModal" class="modal-overlay">
        <div class="modal-dialog modal-info">
            <div class="modal-header">
                <span class="modal-icon">&#8644;</span>
                <span class="modal-title">{{ t('clusters.merge_title') }}</span>
            </div>
            <div class="modal-body">
                <p>{{ t('clusters.merge_message', count='<strong id="mergeCount">0</strong>') | safe }}</p>
                <p style="margin-top: 10px;">{{ t('clusters.merge_select_main') }}</p>
                <div id="mergeTargetOptions" class="merge-target-options" style="margin-top: 15px;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancel" onclick="VideoDetail.closeModal('mergeClustersModal')">{{ t('common.cancel') }}</button>
                <button class="btn btn-confirm" onclick="VideoDetail.confirmMergeClusters()">{{ t('clusters.merge') }}</button>
            </div>
        </div>
    </div>

    <!-- Reference Limit Conflict Modal -->
    <div id="refConflictModal" class="modal-overlay">
        <div class="modal-dialog modal-warning">
            <div class="modal-header">
                <span class="modal-icon">&#9888;</span>
                <span class="modal-title">{{ t('generate_form.ref_conflict_title') }}</span>
            </div>
            <div class="modal-body">
                <p id="refConflictMessage"></p>
            </div>
            <div class="modal-footer" style="flex-direction: column; gap: 10px;">
                <button class="btn btn-primary" id="refConflictReduceCluster" style="width: 100%;">
                    {{ t('generate_form.ref_conflict_reduce_cluster') }}
                </button>
                <button class="btn btn-secondary" id="refConflictRemoveStyle" style="width: 100%;">
                    {{ t('generate_form.ref_conflict_remove_style') }}
                </button>
                <button class="btn btn-cancel" onclick="VideoDetail.closeModal('refConflictModal')" style="width: 100%;">
                    {{ t('common.cancel') }}
                </button>
            </div>
        </div>
    </div>

    <!-- AI Configuration Chips Bar -->
    <div class="ai-config-bar" id="aiConfigBar">
        <span class="ai-config-bar-label">{{ t('ai_config.bar_label') }}</span>

        <!-- Overlay for closing popovers -->
        <div class="ai-config-overlay" id="aiConfigOverlay" onclick="VideoDetail.closeAllAiPopovers()"></div>

        <!-- Text AI Chip -->
        <div class="ai-config-chip-wrapper">
            <div class="ai-config-chip" id="textAiChip" onclick="VideoDetail.toggleAiPopover('textAi')">
                <span class="ai-config-chip-icon">&#129302;</span>
                <div class="ai-config-chip-content">
                    <span class="ai-config-chip-title">{{ t('ai_config.text_ai') }}</span>
                    <span class="ai-config-chip-value" id="textAiChipValue">
                        {{ t('ai_providers.anthropic') }}
                        <span class="ai-config-chip-badge" id="textAiThinkingBadge" style="display: none;">{{ t('ai_config.thinking_badge') }}</span>
                    </span>
                </div>
                <span class="ai-config-chip-arrow">&#9660;</span>
            </div>

            <!-- Text AI Popover -->
            <div class="ai-config-popover" id="textAiPopover">
                <div class="ai-config-popover-header">
                    <span class="ai-config-popover-title">&#129302; {{ t('ai_config.text_config_title') }}</span>
                    <button class="ai-config-popover-close" onclick="VideoDetail.closeAiPopover('textAi')">&times;</button>
                </div>
                <div class="ai-config-popover-body">
                    <div class="form-group">
                        <label for="textAiProvider">{{ t('ai_config.provider') }}</label>
                        <select id="textAiProvider" onchange="VideoDetail.updateTextAiModelOptions()">
                            <option value="anthropic">{{ t('ai_providers.anthropic') }}</option>
                            <option value="openai">{{ t('ai_providers.openai') }}</option>
                            <option value="google">{{ t('ai_providers.google') }}</option>
                            <option value="xai">{{ t('ai_providers.xai') }}</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="textAiModel">{{ t('ai_config.model') }}</label>
                        <select id="textAiModel">
                            <option value="">{{ t('ai_config.loading_models') }}</option>
                        </select>
                    </div>
                    <div class="ai-config-thinking-row">
                        <label class="ai-config-thinking-toggle">
                            <input type="checkbox" id="textAiThinkingEnabled" onchange="VideoDetail.toggleTextAiThinkingLevel()">
                            <span>{{ t('ai_config.thinking_mode') }}</span>
                        </label>
                        <div class="ai-config-thinking-level hidden" id="textAiThinkingLevelGroup">
                            <label for="textAiThinkingLevel">{{ t('ai_config.thinking_level') }}</label>
                            <select id="textAiThinkingLevel">
                                <option value="low">{{ t('ai_config.thinking_low') }}</option>
                                <option value="medium" selected>{{ t('ai_config.thinking_medium') }}</option>
                                <option value="high">{{ t('ai_config.thinking_high') }}</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="ai-config-popover-info">
                    <span class="ai-config-popover-info-icon">&#9432;</span>
                    <span>{{ t('ai_config.text_info') }}</span>
                </div>
            </div>
        </div>

        <!-- Image AI Chip -->
        <div class="ai-config-chip-wrapper">
            <div class="ai-config-chip" id="imageAiChip" onclick="VideoDetail.toggleAiPopover('imageAi')">
                <span class="ai-config-chip-icon">&#128247;</span>
                <div class="ai-config-chip-content">
                    <span class="ai-config-chip-title">{{ t('ai_config.image_ai') }}</span>
                    <span class="ai-config-chip-value" id="imageAiChipValue">
                        {{ t('ai_providers.gemini') }}
                        <span class="ai-config-chip-badge" id="imageAiRefBadge">{{ t('ai_config.refs_badge', count=3) }}</span>
                    </span>
                </div>
                <span class="ai-config-chip-arrow">&#9660;</span>
            </div>

            <!-- Image AI Popover -->
            <div class="ai-config-popover ai-config-popover-wide" id="imageAiPopover">
                <div class="ai-config-popover-header">
                    <span class="ai-config-popover-title">&#128247; {{ t('ai_config.image_config_title') }}</span>
                    <button class="ai-config-popover-close" onclick="VideoDetail.closeAiPopover('imageAi')">&times;</button>
                </div>
                <div class="ai-config-popover-body">
                    <div class="form-group">
                        <label for="imageAiProvider">{{ t('ai_config.image_provider') }}</label>
                        <select id="imageAiProvider" onchange="VideoDetail.updateImageAiModelOptions(true)">
                            <option value="gemini">{{ t('ai_providers.gemini') }}</option>
                            <option value="poe">{{ t('ai_providers.poe') }}</option>
                            <option value="openai">{{ t('ai_providers.openai') }}</option>
                            <option value="replicate">{{ t('ai_providers.replicate') }}</option>
                        </select>
                        <small class="ai-config-ref-indicator supported" id="imageAiRefIndicator">{{ t('ai_config.supports_refs') }}</small>
                    </div>

                    <!-- Gemini Model -->
                    <div class="ai-config-model-subsection" id="imageAiGeminiModelGroup">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="imageAiGeminiModel">{{ t('ai_config.model') }}</label>
                            <select id="imageAiGeminiModel" onchange="VideoDetail.updateImageAiRefMax(true)">
                                <option value="gemini-2.5-flash-image">gemini-2.5-flash-image ({{ t('ai_config.fast') }})</option>
                                <option value="gemini-3-pro-image-preview">gemini-3-pro-image-preview (4K)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Poe Model -->
                    <div class="ai-config-model-subsection" id="imageAiPoeModelGroup" style="display: none;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="imageAiPoeModel">{{ t('ai_config.model') }}</label>
                            <select id="imageAiPoeModel" onchange="VideoDetail.updateImageAiRefMax(true)">
                                <option value="flux2pro">flux2pro - {{ t('ai_config.best_quality') }}</option>
                                <option value="flux2flex">flux2flex - {{ t('ai_config.high_res') }}</option>
                                <option value="fluxkontextpro">fluxkontextpro - {{ t('ai_config.best_prompt') }}</option>
                                <option value="seedream40">seedream40 - {{ t('ai_config.combine_refs') }}</option>
                                <option value="nanobananapro">nanobananapro - Gemini 3</option>
                                <option value="Ideogram-v3">Ideogram-v3 - {{ t('ai_config.text_logos') }}</option>
                            </select>
                        </div>
                    </div>

                    <!-- OpenAI Model -->
                    <div class="ai-config-model-subsection" id="imageAiOpenaiModelGroup" style="display: none;">
                        <div class="warning-box" id="imageAiOpenaiWarning" style="display: none; margin-bottom: 10px;">
                            <strong>{{ t('common.warning') }}:</strong> DALL-E 3 {{ t('ai_config.no_refs_warning') }}
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="imageAiOpenaiModel">{{ t('ai_config.model') }}</label>
                            <select id="imageAiOpenaiModel" onchange="VideoDetail.updateImageAiOpenaiWarning(); VideoDetail.updateImageAiRefMax(true)">
                                <option value="gpt-image-1.5" data-ref="true">gpt-image-1.5 - {{ t('ai_config.best') }}</option>
                                <option value="gpt-image-1" data-ref="true">gpt-image-1 - {{ t('ai_config.standard') }}</option>
                                <option value="gpt-image-1-mini" data-ref="true">gpt-image-1-mini - {{ t('ai_config.fast') }}</option>
                                <option value="dall-e-3" data-ref="false">dall-e-3 - {{ t('ai_config.no_refs') }}</option>
                            </select>
                        </div>
                    </div>

                    <!-- Reference Images -->
                    <div class="form-group" id="imageAiRefGroup" style="margin-top: 14px;">
                        <label for="imageAiNumRefs">
                            {{ t('ai_config.ref_images') }} <span id="imageAiRefMaxLabel" class="ref-max-label">{{ t('ai_config.ref_max', max=3) }}</span>
                        </label>
                        <input type="number" id="imageAiNumRefs" value="3" min="1" max="3">
                    </div>
                </div>
            </div>
        </div>

        <!-- Gran Sabio LLM Status -->
        <span class="gransabio-status unavailable" id="gransabioStatusChip" title="{{ t('ai_config.gran_sabio.status') }}">
            <span class="status-dot"></span>
            <span class="status-text">{{ t('ai_config.gran_sabio.offline') }}</span>
        </span>
    </div>

    <!-- Content Optimization Section (Collapsible with Tabs) -->
    <section class="section content-optimization-section">
        <div class="section-header-collapsible" onclick="VideoDetail.toggleSection('contentSection')">
            <h2>
                <span class="collapse-icon" id="contentSectionIcon">&#9660;</span>
                {{ t('content_optimization.title') }}
            </h2>
        </div>

        <div id="contentSection" class="collapsible-content">
            <!-- Tabs -->
            <div class="content-tabs">
                <button class="tab-btn active" onclick="VideoDetail.switchContentTab('titles')" id="tabTitles">
                    {{ t('content_optimization.tab_titles') }}
                </button>
                <button class="tab-btn" onclick="VideoDetail.switchContentTab('descriptions')" id="tabDescriptions">
                    {{ t('content_optimization.tab_descriptions') }}
                </button>
            </div>

            <!-- Tab Content: Titles -->
            <div id="tabContentTitles" class="tab-content active">
                <div class="content-generation-form content-generation-form-simplified">
                    <div class="form-section">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="titleStyle">{{ t('titles_form.style_label') }} <span class="info-tooltip" data-tooltip="{{ t('titles_form.style_tooltip') }}">&#9432;</span></label>
                                <select id="titleStyle" onchange="VideoDetail.updateTitleStyleUI()">
                                    <option value="neutral">{{ t('titles_form.style_neutral') }}</option>
                                    <option value="seo">{{ t('titles_form.style_seo') }}</option>
                                    <option value="clickbait">{{ t('titles_form.style_clickbait') }}</option>
                                    <option value="custom">{{ t('titles_form.style_custom') }}</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="titleLanguage">{{ t('titles_form.language_label') }}</label>
                                <select id="titleLanguage">
                                    <option value="es" selected>{{ t('languages.es') }}</option>
                                    <option value="en">{{ t('languages.en') }}</option>
                                    <option value="fr">{{ t('languages.fr') }}</option>
                                    <option value="it">{{ t('languages.it') }}</option>
                                    <option value="de">{{ t('languages.de') }}</option>
                                    <option value="pt">{{ t('languages.pt') }}</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="titleQuantity">{{ t('titles_form.quantity_label') }}</label>
                                <input type="number" id="titleQuantity" value="5" min="1" max="50">
                            </div>
                        </div>

                        <div class="form-group" id="customPromptGroup" style="display: none;">
                            <label for="titleCustomPrompt">{{ t('titles_form.custom_prompt_label') }}</label>
                            <textarea id="titleCustomPrompt" rows="3" placeholder="{{ t('titles_form.custom_prompt_placeholder') }}"></textarea>
                        </div>

                        <div class="form-group" id="customInstructionsGroup">
                            <label for="titleCustomInstructions">{{ t('titles_form.instructions_label') }}</label>
                            <textarea id="titleCustomInstructions" rows="2" placeholder="{{ t('titles_form.instructions_placeholder') }}"></textarea>
                        </div>

                        <button type="button" class="btn btn-primary" id="generateTitlesBtn" onclick="VideoDetail.generateTitles()">
                            {{ t('titles_form.generate_button') }}
                        </button>
                    </div>

                    <div class="titles-results-section" id="titlesResultsSection" style="display: none;">
                        <div class="titles-results-header">
                            <h4>{{ t('titles_form.results_header') }} <span id="titlesCount" class="titles-count"></span></h4>
                            <div class="titles-header-actions">
                                <span id="titlesSelectionInfo" class="titles-selection-info" title="{{ t('titles_form.selection_info') }}">
                                    {{ t('titles_form.selection_info') }}
                                </span>
                                <div class="titles-action-buttons">
                                    <button class="btn btn-small btn-secondary" id="selectAllTitlesBtn" onclick="VideoDetail.toggleSelectAllTitles()" title="{{ t('common.select_all') }}">
                                        &#9744; {{ t('titles_form.select_all') }}
                                    </button>
                                    <button class="btn btn-small btn-delete-selected" id="deleteSelectedTitlesBtn" onclick="VideoDetail.deleteSelectedTitles()" title="{{ t('titles_form.delete_selected') }}">
                                        &#128465; {{ t('titles_form.delete_selected') }}
                                    </button>
                                    <button class="btn btn-small btn-secondary" onclick="VideoDetail.copyAllTitles()" title="{{ t('titles_form.copy_all') }}">
                                        &#128203; {{ t('titles_form.copy_all') }}
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="titlesResultsList" class="titles-results-list"></div>
                        <p class="titles-hint">
                            <span class="info-icon">&#9432;</span>
                            {{ t('titles_form.hint') }}
                        </p>
                    </div>

                    <div class="content-loading" id="titlesLoading" style="display: none;">
                        <div class="loading-spinner"></div>
                        <div class="content-loading-text">
                            <span id="titlesLoadingMain">{{ t('titles_form.preparing') }}</span>
                            <small id="titlesLoadingHint"></small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab Content: Descriptions -->
            <div id="tabContentDescriptions" class="tab-content">
                <div class="content-generation-form content-generation-form-simplified">
                    <div class="form-section">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="descStyle">{{ t('descriptions_form.style_label') }}</label>
                                <select id="descStyle" onchange="VideoDetail.updateDescStyleUI()">
                                    <option value="informative">{{ t('descriptions_form.style_informative') }}</option>
                                    <option value="seo">{{ t('descriptions_form.style_seo') }}</option>
                                    <option value="minimal">{{ t('descriptions_form.style_minimal') }}</option>
                                    <option value="custom">{{ t('descriptions_form.style_custom') }}</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="descLanguage">{{ t('descriptions_form.language_label') }}</label>
                                <select id="descLanguage">
                                    <option value="es" selected>{{ t('languages.es') }}</option>
                                    <option value="en">{{ t('languages.en') }}</option>
                                    <option value="fr">{{ t('languages.fr') }}</option>
                                    <option value="it">{{ t('languages.it') }}</option>
                                    <option value="de">{{ t('languages.de') }}</option>
                                    <option value="pt">{{ t('languages.pt') }}</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="descLength">{{ t('descriptions_form.length_label') }}</label>
                                <select id="descLength">
                                    <option value="short">{{ t('descriptions_form.length_short') }}</option>
                                    <option value="medium" selected>{{ t('descriptions_form.length_medium') }}</option>
                                    <option value="long">{{ t('descriptions_form.length_long') }}</option>
                                    <option value="very_long">{{ t('descriptions_form.length_very_long') }}</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="descQuantity">{{ t('descriptions_form.quantity_label') }}</label>
                                <input type="number" id="descQuantity" value="1" min="1" max="3">
                            </div>
                        </div>

                        <!-- Checkboxes for extra options -->
                        <div class="form-group">
                            <label>{{ t('descriptions_form.options_label') }}</label>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="descTimestamps">
                                    <span>{{ t('descriptions_form.timestamps') }} <span class="info-tooltip" data-tooltip="{{ t('descriptions_form.timestamps_tooltip') }}">&#9432;</span></span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="descHashtags">
                                    <span>{{ t('descriptions_form.hashtags') }}</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="descEmojis">
                                    <span>{{ t('descriptions_form.emojis') }}</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="descSocialLinks">
                                    <span>{{ t('descriptions_form.social_links') }}</span>
                                </label>
                            </div>
                        </div>

                        <div class="form-group" id="descCustomPromptGroup" style="display: none;">
                            <label for="descCustomPrompt">{{ t('descriptions_form.custom_prompt_label') }}</label>
                            <textarea id="descCustomPrompt" rows="3" placeholder="{{ t('descriptions_form.custom_prompt_placeholder') }}"></textarea>
                        </div>

                        <div class="form-group" id="descCustomInstructionsGroup">
                            <label for="descCustomInstructions">{{ t('descriptions_form.instructions_label') }}</label>
                            <textarea id="descCustomInstructions" rows="2" placeholder="{{ t('descriptions_form.instructions_placeholder') }}"></textarea>
                        </div>

                        <button type="button" class="btn btn-primary" id="generateDescBtn" onclick="VideoDetail.generateDescriptions()">
                            {{ t('descriptions_form.generate_button') }}
                        </button>
                    </div>

                    <div class="form-section descriptions-results-section" id="descriptionsResultsSection" style="display: none;">
                        <div class="descriptions-results-header">
                            <h4>{{ t('descriptions_form.results_header') }} <span id="descriptionsCount" class="descriptions-count"></span></h4>
                            <div class="descriptions-header-actions">
                                <div class="descriptions-action-buttons">
                                    <button class="btn btn-small btn-delete-selected" id="deleteAllDescriptionsBtn" onclick="VideoDetail.deleteAllDescriptions()" title="{{ t('descriptions_form.delete_all') }}">
                                        &#128465; {{ t('descriptions_form.delete_all') }}
                                    </button>
                                    <button class="btn btn-small btn-secondary" onclick="VideoDetail.copyAllDescriptions()" title="{{ t('descriptions_form.copy_all') }}">
                                        &#128203; {{ t('descriptions_form.copy_all') }}
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="descriptionsResultsList" class="descriptions-results-list"></div>
                    </div>

                    <div class="content-loading" id="descriptionsLoading" style="display: none;">
                        <div class="loading-spinner"></div>
                        <div class="content-loading-text">
                            <span id="descriptionsLoadingMain">{{ t('descriptions_form.preparing') }}</span>
                            <small id="descriptionsLoadingHint"></small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Generation form -->
    <section class="section">
        <h2>{{ t('generate_form.title') }}</h2>
        <form id="generateForm" class="generate-form generate-form-simplified">
            <div class="form-group cluster-select-group">
                <label>{{ t('generate_form.cluster_label') }} <span class="info-tooltip" data-tooltip="{{ t('generate_form.cluster_tooltip') }}">&#9432;</span></label>
                <div id="selectedClusterDisplay" class="selected-cluster-display">
                    <span class="no-selection">&#9734; {{ t('generate_form.no_cluster_selected') }}</span>
                </div>
                <select id="clusterSelect" required style="display: none;">
                    <option value="">{{ t('common.select') }}</option>
                </select>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="numImages">{{ t('generate_form.images_label') }} <span class="info-tooltip" data-tooltip="{{ t('generate_form.images_tooltip') }}">&#9432;</span></label>
                    <input type="number" id="numImages" value="5" min="1" max="50">
                </div>
                <div class="form-group">
                    <label for="expression">{{ t('generate_form.expression_label') }}</label>
                    <select id="expression">
                        <option value="">{{ t('generate_form.expression_auto') }}</option>
                        <option value="smiling">{{ t('generate_form.expression_smiling') }}</option>
                        <option value="mouth_closed">{{ t('generate_form.expression_mouth_closed') }}</option>
                        <option value="neutral">{{ t('generate_form.expression_neutral') }}</option>
                    </select>
                </div>
            </div>

            <div class="form-row" style="margin-top: 10px;">
                <label class="checkbox-label">
                    <input type="checkbox" id="promptIncludeHistory">
                    <span>{{ t('generate_form.avoid_repeat') }}</span>
                </label>
            </div>

            <!-- Reference Image Section -->
            <div class="form-group reference-image-group" style="margin-top: 15px;">
                <label for="referenceImageInput">
                    {{ t('generate_form.reference_image_label') }}
                    <span class="info-tooltip" data-tooltip="{{ t('generate_form.reference_image_tooltip') }}">&#9432;</span>
                </label>

                <div class="reference-image-upload">
                    <input type="file" id="referenceImageInput" accept="image/*" style="display: none;">
                    <button type="button" class="btn btn-secondary btn-small" onclick="document.getElementById('referenceImageInput').click()">
                        &#128247; {{ t('generate_form.select_image') }}
                    </button>
                    <span id="referenceImageName" class="reference-image-name">{{ t('generate_form.no_image_selected') }}</span>
                </div>

                <div id="referenceImagePreview" class="reference-image-preview" style="display: none;">
                    <img id="referenceImageImg" src="" alt="Preview">
                    <button type="button" id="clearReferenceImage" class="reference-image-clear"
                            onclick="VideoDetail.clearReferenceImage()" title="{{ t('generate_form.remove_image') }}">
                        &#10005;
                    </button>
                </div>

                <div id="referenceImageOptions" class="reference-image-options" style="display: none; margin-top: 10px;">
                    <span class="reference-image-info">
                        &#10003; {{ t('generate_form.style_ref_always_used') }}
                    </span>
                    <span id="styleRefWarning" class="style-ref-warning" style="display: none;"></span>
                </div>
            </div>

            <!-- Custom Instructions (at the end, as they override everything) -->
            <div class="form-group" style="margin-top: 15px;">
                <label for="promptCustomInstructions">
                    {{ t('generate_form.instructions_label') }}
                    <span class="info-tooltip" data-tooltip="{{ t('generate_form.instructions_tooltip') }}">&#9432;</span>
                </label>
                <textarea id="promptCustomInstructions" class="custom-instructions-textarea" placeholder="{{ t('generate_form.instructions_placeholder') }}"></textarea>
            </div>

            <div class="generation-button-wrapper">
                <div class="generation-button-group">
                    <button type="submit" class="btn btn-primary btn-generate" id="generateBtn">
                        {{ t('generate_form.generate_button') }}
                    </button>
                    <!-- Queue badge - shows task count for this video -->
                    <span class="generation-queue-badge hidden" id="generationQueueBadge">0</span>
                    <button type="button" class="btn btn-danger btn-cancel hidden" id="cancelGenerationBtn"
                            title="{{ t('task_queue.cancel') }}">
                        ‚ñ†
                    </button>
                </div>
                <!-- Queue status line below button -->
                <div class="generation-queue-status hidden" id="generationQueueStatus">
                    <span class="queue-status-icon">‚è≥</span>
                    <span class="queue-status-text" id="generationQueueText"></span>
                    <a href="#" class="queue-status-link" id="generationQueueLink">{{ t('queue_indicator.view') }}</a>
                </div>
            </div>
        </form>
    </section>

    <!-- Generation status -->
    <section class="section hidden" id="generationStatus">
        <h2>{{ t('generate_form.progress_title') }}</h2>
        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <p id="progressText">{{ t('generate_form.progress_starting') }}</p>
        </div>
    </section>

    <!-- Results (shown during/after generation) -->
    <section class="section hidden" id="resultsSection">
        <h2>{{ t('generate_form.results_generating') }}</h2>
        <div id="thumbnailsGrid" class="thumbnails-grid"></div>
    </section>

    <!-- Existing Thumbnails Gallery -->
    <section class="section" id="existingThumbnailsSection">
        <div class="section-header-with-actions">
            <h2>
                <span>{{ t('thumbnails.saved_title') }}</span>
                <span class="thumbnail-count-badge" id="thumbnailCountBadge">0</span>
            </h2>
            <div class="section-actions">
                <button class="btn btn-secondary btn-small" id="downloadAllBtn" onclick="VideoDetail.downloadAllThumbnails()" style="display: none;">
                    &#128230; {{ t('thumbnails.download_all') }}
                </button>
            </div>
        </div>
        <div class="existing-thumbnails-wrapper" id="existingThumbnailsWrapper">
            <div class="existing-thumbnails-container" id="existingThumbnailsContainer">
                <div class="existing-thumbnails-grid" id="existingThumbnailsGrid">
                    <div class="loading">{{ t('thumbnails.loading') }}</div>
                </div>
            </div>
        </div>
        <div class="no-thumbnails-message" id="noThumbnailsMessage" style="display: none;">
            <div class="empty-state">
                <span class="empty-icon">üñºÔ∏è</span>
                <p>{{ t('empty_state.no_thumbnails') }}</p>
                <small>{{ t('empty_state.thumbnails_hint') }}</small>
            </div>
        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script type="module" src="/static/js/video_detail/main.js"></script>
{% endblock %}
