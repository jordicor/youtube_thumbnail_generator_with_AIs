{% extends "base.html" %}

{% block title %}{{ t('results.title', id=job_id) }}{% endblock %}

{% block content %}
<div class="page-header">
    <a href="/" class="back-link">&larr; {{ t('results.back') }}</a>
    <h1>{{ t('results.thumbnails.title') }}</h1>
</div>

<div id="jobInfo" class="job-info">
    <div class="loading">{{ t('results.loading_info') }}</div>
</div>

<div id="actionsBar" class="actions-bar" style="display: none;">
    <a id="downloadAllBtn" href="#" class="btn btn-primary">
        {{ t('results.thumbnails.download_all_zip') }}
    </a>
    <button id="regenerateBtn" class="btn btn-secondary" onclick="regenerate()">
        {{ t('results.regenerate') }}
    </button>
</div>

<div id="thumbnailsGrid" class="thumbnails-grid">
    <div class="loading">{{ t('results.loading_thumbnails') }}</div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const jobId = {{ job_id }};

    document.addEventListener('DOMContentLoaded', () => {
        loadJobInfo();
        loadThumbnails();
        setupDownloadButton();
    });

    function setupDownloadButton() {
        const downloadBtn = document.getElementById('downloadAllBtn');
        downloadBtn.href = `/api/thumbnails/job/${jobId}/download-all`;
    }

    async function loadJobInfo() {
        try {
            const response = await fetch(`/api/generation/jobs/${jobId}/status`);
            const data = await response.json();

            const infoDiv = document.getElementById('jobInfo');
            infoDiv.innerHTML = `
                <p><strong>${t('results.status')}:</strong> ${escapeHtml(data.status)}</p>
                <p><strong>${t('results.progress')}:</strong> ${escapeHtml(data.progress)}%</p>
                <p><strong>${t('results.thumbnails_count')}:</strong> ${data.thumbnails_generated}/${data.total_thumbnails}</p>
            `;
        } catch (error) {
            document.getElementById('jobInfo').innerHTML =
                `<div class="error">${t('errors.load_info')}: ${escapeHtml(error.message)}</div>`;
        }
    }

    async function loadThumbnails() {
        const grid = document.getElementById('thumbnailsGrid');
        const actionsBar = document.getElementById('actionsBar');

        try {
            const response = await fetch(`/api/generation/jobs/${jobId}/thumbnails`);
            const thumbnails = await response.json();

            if (thumbnails.length === 0) {
                grid.innerHTML = `<p>${t('results.no_thumbnails_yet')}</p>`;
                actionsBar.style.display = 'none';
                return;
            }

            // Show actions bar when there are thumbnails
            actionsBar.style.display = 'flex';
            grid.innerHTML = '';

            for (const thumb of thumbnails) {
                const card = document.createElement('div');
                card.className = 'thumbnail-card';
                card.innerHTML = `
                    <img src="/api/thumbnails/${thumb.id}" alt="Thumbnail ${thumb.image_index}">
                    <div class="thumbnail-info">
                        <h4>${escapeHtml(thumb.suggested_title) || 'Thumbnail ' + thumb.image_index}</h4>
                        <p>${escapeHtml(thumb.text_overlay) || ''}</p>
                        <div class="thumbnail-actions">
                            <a href="/api/thumbnails/${thumb.id}" download class="btn btn-primary btn-small">
                                ${t('results.thumbnails.download')}
                            </a>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            }
        } catch (error) {
            grid.innerHTML = `<div class="error">${t('errors.load_thumbnails')}: ${escapeHtml(error.message)}</div>`;
            actionsBar.style.display = 'none';
        }
    }

    function regenerate() {
        // Go back to video detail page to regenerate
        window.history.back();
    }
</script>
{% endblock %}
